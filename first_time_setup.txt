FIRST TIME SETUP


fresh install. Ubuntu 22.04, CUDA 12.3.1



1. install Ubuntu

https://apps.microsoft.com/detail/9pn20msr04dw?hl=en-US&gl=US





2. in Ubuntu (launch from search bar)

sudo apt update && sudo apt -y full-upgrade
sudo apt -y install build-essential git curl wget unzip tar pigz \
    cmake pkg-config ca-certificates \
    python3 python3-pip python3-venv \
    openbabel jq \
    libglib2.0-0 libxrender1 libxext6 libsm6 \
	build-essential scons git python3-dev zlib1g-dev libbz2-dev \
	docker-ce docker-ce-cli containerd.io \
	docker-buildx-plugin docker-compose-plugin nvidia-container-toolkit

conda install -c conda-forge setuptools pandas scipy biopython gemmi rdkit zlib bzip2 rust cudatoolkit-dev pandas gemmi requests scipy biopython rdkit zlib bzip2 rust colorama 

conda install -c nvidia cuda-toolkit
conda install -c conda-forge absl-py

python3 -c "import pandas,gemmi; print('pandas',pandas.__version__); print('gemmi OK')"
	
git config --global pull.rebase false

pip install "numpy<2" pybel





3. increase vdisk to desired size

#in powershell:

wsl --shutdown

diskpart

select vdisk file="C:\Users\olive\AppData\Local\Packages\CanonicalGroupLimited.Ubuntu22.04LTS_79rhkp1fndgsc\LocalState\ext4.vhdx"
expand vidsk maximum=1500000
exit

#in powershell:

wsl
sudo resize2fs /dev/sdd
df -h /





4. install Miniconda

wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh

bash Miniconda3-latest-Linux-x86_64.sh

# say yes when prompted

source ~/.bashrc

conda --version

conda create -n af3 python=3.11 -c conda-forge cuda-nvcc=12.3 cuda-cudart-dev=12.3

conda activate af3





5. install docker

sudo mkdir -p /etc/apt/keyrings

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

sudo chmod a+r /etc/apt/keyrings/docker.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
  https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

#if run into errors:

sudo rm /etc/apt/sources.list.d/docker.list
sudo rm -f /etc/apt/keyrings/docker.*

#then repeat previous commands to install docker

docker --version

sudo usermod -aG docker $USER
newgrp docker
docker run hello-world





6. enable docker to use GPU

distribution=$(. /etc/os-release;echo $ID$VERSION_ID) \
    && curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
    && curl -s -L https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.list | \
       sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
       sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list

sudo nvidia-ctk runtime configure --runtime=docker
sudo systemctl restart docker

sudo nano /etc/docker/daemon.json

#add 

"default-runtime": "nvidia", 

#to line 2 of the file. have it line up with

"runtimes": {

#crtl-O, enter, crtl-X

sudo systemctl restart docker

docker info | grep -i runtime

docker run --rm --gpus all nvidia/cuda:12.3.1-base-ubuntu22.04 nvidia-smi





7. create project and clone alphafold

mkdir -p ~/Repositories/alphafold/{af_input,af_output,af_weights,public_databases,mmseqs_db,msa_cache}
cd ~/Repositories/alphafold

#place af3.bin.zst in af_weights folder
sudo apt install zstd
cd ~/Repositories/alphafold/af_weights
unzstd af3.bin.zst

git clone https://github.com/google-deepmind/alphafold3.git
cd alphafold3





8. patch xla implementation and add gemmi to dockerfile

#modify attention.py located at /alphafold3/src/alphafold3/jax/attention/attention.py

#remove final if(triton) block before the return statement

cd ~/Repositories/alphafold/alphafold3

nano docker/Dockerfile

#add:

RUN python3 -m venv /venv \
    && /venv/bin/pip install --upgrade pip \
    && /venv/bin/pip install gemmi pandas requests
ENV PATH="/venv/bin:$PATH"

#replace the block that looks like this near the top of the file

docker build --network=host -f docker/Dockerfile -t alphafold3 .





9. install mmseqs2

sudo apt update
sudo apt-get install build-essential procps curl file git

/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.profile
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

brew install mmseqs2





10. mmseqs database
#download uniref30_2302.db.tar.gz from https://opendata.mmseqs.org/colabfold

cp /mnt/c/Users/olive/Downloads/uniref30_2302.db.tar.gz ~/Repositories/alphafold/mmseqs_db/uniref30_2302.db.tar.gz
cd ~/Repositories/alphafold/mmseqs_db
tar -xzf uniref30_2302.db.tar.gz

export MMSEQS_NUM_THREADS=20
echo $MMSEQS_NUM_THREADS





11. sanity checks

ls ~/Repositories/alphafold/af_input \
   ~/Repositories/alphafold/af_output \
   ~/Repositories/alphafold/af_weights \
   ~/Repositories/alphafold/public_databases
   
docker run --rm -it \
  --gpus all \
  --volume ~/Repositories/alphafold/af_input:/work/af_input \
  --volume ~/Repositories/alphafold/af_output:/work/af_output \
  --volume ~/Repositories/alphafold/af_weights:/work/models \
  --volume ~/Repositories/alphafold/public_databases:/public_databases \
  alphafold3 python -c "print('container OK')"
  
mmseqs easy-search <(echo -e ">q\nMKT...YOURSEQ") ~/Repositories/alphafold/mmseqs_db/uniref30_2302_db outDB tmp && echo OK

# if any errors, go back and repeat



for covalent Rosetta minimization

download rosetta from https://downloads.rosettacommons.org/downloads/academic/2021/wk16/

#get rosetta source + binaries for Linux as one bundle

#copy to WSL

cp /mnt/c/Users/olive/Downloads/rosetta_bin_linux_2021.16.61629_bundle.tgz ~/rosetta/rosetta_bin_linux_2021.16.61629_bundle.tgz

cd ~/rosetta

tar -xvjf rosetta_bin_linux_3.14_bundle.tar.bz2

#copy LYX.params to \\wsl.localhost\Ubuntu-22.04\home\olive\rosetta\rosetta_bin_linux_2021.16.61629_bundle\main\database\chemical\residue_type_sets\fa_standard\residue_types\l-caa

#code renames covalent modified LYS to LYX. rosetta rebuilds (essentially lysine minus the nitrogen




12. run alphafold

#required scripts in ~/Repositories/alphafold
run_alphafold.py
prepare_covalent_ligand.py
convert_cif.py

mkdir ~/Repositories/alphafold/ligands

python prepare_covalent_ligand.py "OC1=CC=CC=C1C2=CC(N3CC4N(C5=CC(C#CCN6CCCCCC6)=NC=C5)C(CC4)C3)=C(N)N=N2" cmpd1.cif

cp ~/Repositories/alphafold/ligands/cmpd1.cif ~/Repositories/alphafold/af_input/cmpd1.cif

chmod +x ~/Repositories/alphafold/run_alphafold.py

python3 run_alphafold.py